<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klasemen & Jadwal Liga Efootball</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        .bg-custom-card { background-color: #ffffff; } /* bg-white */
        .bg-custom-modal { background-color: #f9fafb; } /* bg-gray-50 */

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .modal-backdrop {
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
        }
        .header-gradient {
            background-image: linear-gradient(145deg, rgba(255, 255, 255, 0.2), rgba(168, 85, 247, 0.1));
        }
        /* Loader styles */
        #loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #8b5cf6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex flex-col items-center justify-center z-50">
        <div id="loader"></div>
        <p class="text-white mt-4">Memuat data...</p>
    </div>

    <!-- Admin Login Modal -->
    <div id="login-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-custom-card p-8 rounded-lg shadow-2xl w-full max-w-sm relative border border-gray-200">
            <button id="close-login-btn" class="absolute top-3 right-4 text-gray-500 hover:text-gray-800 text-2xl font-bold focus:outline-none">&times;</button>
            <h2 class="text-2xl font-bold text-center text-gray-900 mb-6">Login Admin</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="password" class="block text-gray-600 mb-2">Password</label>
                    <input type="password" id="password" class="w-full bg-gray-100 border border-gray-300 rounded-lg px-4 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                </div>
                <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105">Masuk</button>
                <p id="login-error" class="text-red-500 text-center mt-4 hidden">Password salah!</p>
            </form>
        </div>
    </div>
    
    <!-- Management Modal -->
    <div id="management-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 modal-backdrop flex items-center justify-center z-40 p-4">
        <div class="bg-custom-card rounded-lg shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col relative border border-gray-200 text-gray-800">
            <div class="flex items-center justify-between p-4 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-900">Panel Pengelolaan</h2>
                <button id="close-management-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold focus:outline-none">&times;</button>
            </div>
            <div class="flex-grow p-4 overflow-y-auto bg-gray-50">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Kolom Liga -->
                    <div class="md:col-span-1 bg-white p-4 rounded-lg border border-gray-200">
                        <h3 class="text-xl font-semibold mb-3 text-gray-900">Daftar Liga</h3>
                        <div id="leagues-list" class="space-y-2 mb-4"></div>
                        <button id="add-league-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Tambah Liga Baru</button>
                    </div>
                    <!-- Kolom Tim & Pertandingan -->
                    <div class="md:col-span-2 bg-white p-4 rounded-lg border border-gray-200">
                        <div class="flex border-b border-gray-200 mb-4">
                            <button data-tab="teams" class="tab-btn flex-1 py-2 text-center font-semibold border-b-2 border-purple-500 text-purple-600">Tim</button>
                            <button data-tab="matches" class="tab-btn flex-1 py-2 text-center font-semibold border-transparent text-gray-500 hover:text-gray-800">Pertandingan</button>
                        </div>
                        <!-- Konten Tab Tim -->
                        <div id="teams-content" class="tab-content">
                            <div id="teams-list" class="space-y-2 mb-4"></div>
                            <button id="add-team-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Tambah Tim Baru</button>
                        </div>
                        <!-- Konten Tab Pertandingan -->
                        <div id="matches-content" class="hidden tab-content">
                             <div id="matches-list" class="space-y-4 mb-4"></div>
                            <button id="add-match-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Tambah Pertandingan</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- League Editor Modal -->
    <div id="league-editor-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 modal-backdrop flex items-center justify-center z-50 p-4">
        <div class="bg-custom-card rounded-lg shadow-2xl w-full max-w-2xl h-[90vh] flex flex-col relative border border-gray-200 text-gray-800">
            <div class="flex items-center justify-between p-4 border-b border-gray-200">
                <h2 id="league-editor-title" class="text-2xl font-bold text-gray-900"></h2>
                <button id="cancel-league-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold focus:outline-none">&times;</button>
            </div>
            <div class="flex-grow p-6 overflow-y-auto">
                <div class="mb-6">
                    <label for="league-editor-name" class="block text-gray-600 mb-2 font-semibold">Nama Liga</label>
                    <input type="text" id="league-editor-name" class="w-full bg-gray-100 border border-gray-300 rounded-lg px-4 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Pilih Tim yang Sudah Ada</h3>
                    <div id="existing-teams-checklist" class="max-h-48 overflow-y-auto grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2 p-3 bg-gray-50 rounded-md border border-gray-200">
                        <!-- Checkboxes will be injected here -->
                    </div>
                </div>
                <div>
                     <h3 class="text-lg font-semibold text-gray-700 mb-3">Tambah Tim Baru</h3>
                    <p class="text-sm text-gray-500 mb-2">Pisahkan setiap nama tim dengan koma.</p>
                    <textarea id="new-teams-textarea" rows="3" class="w-full bg-gray-100 border border-gray-300 rounded-lg px-4 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Contoh: Tim A, Tim B, Tim C"></textarea>
                </div>
                <div class="mt-6">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="generate-matches-checkbox" class="form-checkbox h-5 w-5 bg-gray-200 border-gray-300 text-purple-600 focus:ring-purple-500">
                        <span class="text-gray-700 font-semibold">Generate Jadwal Otomatis (Kompetisi Penuh)</span>
                    </label>
                    <p class="text-sm text-gray-500 mt-2 ml-8">
                        Penting: Jika dicentang, semua jadwal pertandingan yang ada untuk liga ini akan dihapus dan diganti dengan jadwal baru.
                    </p>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t border-gray-200">
                <button id="save-league-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Simpan Liga</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="invisible">
        <div class="container mx-auto p-4 md:p-8">
            <header class="relative text-center mb-10 bg-white rounded-xl p-6 shadow-lg border border-gray-200">
                <div class="flex items-center justify-center">
                    <h1 id="league-title" class="text-4xl md:text-5xl font-extrabold text-gray-900 tracking-tight"></h1>
                </div>
                <p class="text-gray-500 mt-2">Klasemen, Jadwal, dan Hasil Pertandingan</p>
                
                <div class="mt-8 flex flex-col items-center space-y-4">
                    <!-- Tombol Admin -->
                    <div class="flex justify-center items-center space-x-4">
                        <button id="manage-data-btn" class="hidden bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg transition duration-300 shadow-md">Kelola Data</button>
                        <button id="show-login-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-5 rounded-lg transition duration-300 shadow-md transform hover:scale-105">Login Admin</button>
                        <button id="exit-admin-btn" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-lg transition duration-300 shadow-md">Keluar Mode Admin</button>
                    </div>
                    <!-- Pilihan Liga -->
                    <div class="flex items-center mt-4">
                        <label for="league-selector" class="mr-2 text-gray-500">Pilih Liga:</label>
                        <select id="league-selector" class="bg-gray-200 border border-gray-300 rounded-lg px-3 py-1 text-gray-900 focus:outline-none focus:ring-2 focus:ring-purple-500"></select>
                    </div>
                </div>
            </header>

            <!-- Tab Navigation -->
            <div class="mb-6 border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="tab-btn-klasemen" class="tab-main-btn whitespace-nowrap py-4 px-1 border-b-2 font-semibold text-base border-purple-500 text-purple-600">
                        Klasemen
                    </button>
                    <button id="tab-btn-jadwal" class="tab-main-btn whitespace-nowrap py-4 px-1 border-b-2 font-semibold text-base border-transparent text-gray-500 hover:text-gray-800 hover:border-gray-400">
                        Jadwal & Hasil
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div>
                <!-- Klasemen Panel -->
                <div id="tab-content-klasemen" class="tab-main-content bg-custom-card p-4 md:p-6 rounded-lg shadow-lg border border-gray-200/80">
                    <h2 class="text-2xl font-bold mb-4 border-b border-gray-200 pb-2 text-gray-900">Klasemen Liga</h2>
                    <div id="table-placeholder" class="text-center py-10 text-gray-400">Belum ada tim di liga ini.</div>
                    <div id="table-container" class="overflow-x-auto">
                        <table class="w-full text-xs text-left">
                            <thead class="text-xs text-gray-500 uppercase bg-gray-100">
                                <tr>
                                    <th scope="col" class="px-1 py-2">Pos</th><th scope="col" class="px-2 py-2">Team</th><th scope="col" class="px-1 py-2 text-center" title="Played">P</th><th scope="col" class="px-1 py-2 text-center" title="Won">W</th><th scope="col" class="px-1 py-2 text-center" title="Drawn">D</th><th scope="col" class="px-1 py-2 text-center" title="Lost">L</th><th scope="col" class="px-1 py-2 text-center" title="Goals For">GF</th><th scope="col" class="px-1 py-2 text-center" title="Goals Against">GA</th><th scope="col" class="px-1 py-2 text-center" title="Goal Difference">GD</th><th scope="col" class="px-1 py-2 text-center" title="Points">Pts</th>
                                </tr>
                            </thead>
                            <tbody id="league-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Jadwal Panel -->
                <div id="tab-content-jadwal" class="tab-main-content hidden">
                    <div id="admin-view-header" class="hidden text-center mb-4 p-2 bg-green-100 border border-green-300 rounded-lg"><h2 class="text-xl font-bold text-green-800">Panel Admin Aktif</h2></div>
                    <div id="fixtures-list" class="space-y-6"></div>
                </div>
            </div>
            
            <footer class="text-center mt-12 text-gray-400"><p>Dibuat untuk Komunitas Efootball</p></footer>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCfikX-HQuKhtSksHzyJwuBF-dUr0ckGRE",
            authDomain: "wayliga.firebaseapp.com",
            projectId: "wayliga",
            storageBucket: "wayliga.appspot.com",
            messagingSenderId: "178418335963",
            appId: "1:178418335963:web:a9ff5dadc64fa9cdcf8cfe",
            measurementId: "G-5QDKCZDL8X"
        };

        // Firebase instances
        let app, db, auth, userId;

        // --- DATA INITIALIZATION ---
        function getInitialData() {
             return {
                leagues: [{
                    id: crypto.randomUUID(),
                    name: 'Liga EFootball Way Kanan',
                    teams: ["Arief HD", "Dexulmantap", "Bayu", "Ptangpteng", "Tuku Pulsa Tsel", "Gusmurtad", "The Familia FC", "Riders", "Ipangopen"],
                    matches: [
                        { pekan: 1, matchId: 1, homeTeam: "Arief HD", homeScore: 3, awayScore: 2, awayTeam: "Dexulmantap", status: "Finished" },{ pekan: 1, matchId: 2, homeTeam: "Bayu", homeScore: 2, awayScore: 3, awayTeam: "Ptangpteng", status: "Finished" },{ pekan: 1, matchId: 3, homeTeam: "Tuku Pulsa Tsel", homeScore: 3, awayScore: 4, awayTeam: "Gusmurtad", status: "Finished" },{ pekan: 1, matchId: 4, homeTeam: "The Familia FC", homeScore: 0, awayScore: 3, awayTeam: "Riders", status: "Finished" }, { pekan: 1, matchId: 101, homeTeam: "Ipangopen", awayTeam: "Libur", status: "Scheduled" },
                        { pekan: 2, matchId: 5, homeTeam: "Ipangopen", homeScore: 8, awayScore: 2, awayTeam: "Riders", status: "Finished" },{ pekan: 2, matchId: 6, homeTeam: "Arief HD", homeScore: 3, awayScore: 3, awayTeam: "Gusmurtad", status: "Finished" },{ pekan: 2, matchId: 7, homeTeam: "Ptangpteng", homeScore: 2, awayScore: 1, awayTeam: "Tuku Pulsa Tsel", status: "Finished" },{ pekan: 2, matchId: 8, homeTeam: "Dexulmantap", homeScore: 3, awayScore: 6, awayTeam: "The Familia FC", status: "Finished" }, { pekan: 2, matchId: 102, homeTeam: "Bayu", awayTeam: "Libur", status: "Scheduled" },
                    ]
                }],
                activeLeagueId: null
            };
        }

        let appData = {};
        let isAdmin = false;

        // --- DOM ELEMENTS ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const mainContent = document.getElementById('main-content');
        const loginModal = document.getElementById('login-modal');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const showLoginBtn = document.getElementById('show-login-btn');
        const closeLoginBtn = document.getElementById('close-login-btn');
        const exitAdminBtn = document.getElementById('exit-admin-btn');
        const manageDataBtn = document.getElementById('manage-data-btn');
        const adminViewHeader = document.getElementById('admin-view-header');
        const leagueTableBody = document.getElementById('league-table-body');
        const fixturesList = document.getElementById('fixtures-list');
        const leagueTitle = document.getElementById('league-title');
        const leagueSelector = document.getElementById('league-selector');
        const managementModal = document.getElementById('management-modal');
        const closeManagementBtn = document.getElementById('close-management-btn');
        const tablePlaceholder = document.getElementById('table-placeholder');
        const tableContainer = document.getElementById('table-container');

        // Main Tab Elements
        const tabBtnKlasemen = document.getElementById('tab-btn-klasemen');
        const tabBtnJadwal = document.getElementById('tab-btn-jadwal');
        const allTabBtns = document.querySelectorAll('.tab-main-btn');
        const allTabContents = document.querySelectorAll('.tab-main-content');

        // --- DATA FUNCTIONS ---
        async function loadData() {
            if (!userId) return;
            loadingOverlay.classList.remove('hidden');
            
            const docRef = doc(db, "league_data", userId);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    appData = docSnap.data();
                } else {
                    console.log("No such document! Creating initial data.");
                    appData = getInitialData();
                    if (appData.leagues.length > 0) {
                        appData.activeLeagueId = appData.leagues[0].id;
                    }
                    await saveData(); // Save the initial data to Firestore
                }
                if (!appData.activeLeagueId && appData.leagues.length > 0) {
                    appData.activeLeagueId = appData.leagues[0].id;
                }
            } catch (error) {
                console.error("Error loading data:", error);
                alert("Gagal memuat data dari server.");
                appData = getInitialData(); // Fallback to local initial data
            } finally {
                renderAll();
                loadingOverlay.classList.add('hidden');
                mainContent.classList.remove('invisible');
            }
        }

        async function saveData() {
            if (!userId) return;
            try {
                await setDoc(doc(db, "league_data", userId), appData);
            } catch (error) {
                console.error("Error saving data:", error);
                alert("Gagal menyimpan data ke server.");
            }
        }

        function getActiveLeague() {
            if (!appData.leagues || appData.leagues.length === 0) return null;
            return appData.leagues.find(l => l.id === appData.activeLeagueId);
        }

        // --- RENDER FUNCTIONS ---
        function renderAll() {
            renderLeagueSelector();
            const activeLeague = getActiveLeague();
            if (!activeLeague) {
                leagueTitle.textContent = "Tidak Ada Liga";
                leagueTableBody.innerHTML = '';
                fixturesList.innerHTML = '';
                tablePlaceholder.classList.remove('hidden');
                tableContainer.classList.add('hidden');
                return;
            }
            
            leagueTitle.textContent = activeLeague.name;
            const teams = calculateLeagueTable(activeLeague);
            renderLeagueTable(teams);
            renderFixtures(activeLeague);
            if(isAdmin) renderManagementModal();
        }

        function renderLeagueSelector() {
            leagueSelector.innerHTML = '';
            appData.leagues.forEach(league => {
                const option = document.createElement('option');
                option.value = league.id;
                option.textContent = league.name;
                if (league.id === appData.activeLeagueId) {
                    option.selected = true;
                }
                leagueSelector.appendChild(option);
            });
        }
        
        function calculateLeagueTable(league) {
            const teamStats = {};
            if (!league || !league.teams) return [];
            
            league.teams.forEach(teamName => {
                teamStats[teamName] = { name: teamName, P: 0, M: 0, S: 0, K: 0, GM: 0, GK: 0, SG: 0, Poin: 0 };
            });

            (league.matches || []).filter(m => m.status === 'Finished').forEach(match => {
                if (!teamStats[match.homeTeam] || !teamStats[match.awayTeam]) return;
                const home = teamStats[match.homeTeam];
                const away = teamStats[match.awayTeam];
                home.P += 1; away.P += 1; home.GM += match.homeScore; home.GK += match.awayScore; away.GM += match.awayScore; away.GK += match.homeScore;
                if (match.homeScore > match.awayScore) { home.M += 1; home.Poin += 3; away.K += 1; } 
                else if (match.homeScore < match.awayScore) { away.M += 1; away.Poin += 3; home.K += 1; } 
                else { home.S += 1; away.S += 1; home.Poin += 1; away.Poin += 1; }
            });

            return Object.values(teamStats).map(team => {
                team.SG = team.GM - team.GK; return team;
            }).sort((a, b) => b.Poin - a.Poin || b.SG - a.SG || b.GM - a.GM || a.name.localeCompare(b.name));
        }

        function renderLeagueTable(teams) {
            if (teams.length === 0) {
                tablePlaceholder.classList.remove('hidden');
                tableContainer.classList.add('hidden');
                return;
            }
            tablePlaceholder.classList.add('hidden');
            tableContainer.classList.remove('hidden');
            
            leagueTableBody.innerHTML = '';
            teams.forEach((team, index) => {
                const row = document.createElement('tr');
                row.className = "border-b border-gray-200 hover:bg-gray-100";
                
                row.innerHTML = `
                    <td class="px-1 py-1.5 font-medium text-gray-900">${index + 1}</td>
                    <td class="px-2 py-1.5 font-semibold text-gray-900 bg-gray-50">${team.name}</td>
                    <td class="px-1 py-1.5 text-center">${team.P}</td>
                    <td class="px-1 py-1.5 text-center text-green-600">${team.M}</td>
                    <td class="px-1 py-1.5 text-center text-yellow-600">${team.S}</td>
                    <td class="px-1 py-1.5 text-center text-red-600">${team.K}</td>
                    <td class="px-1 py-1.5 text-center">${team.GM}</td>
                    <td class="px-1 py-1.5 text-center">${team.GK}</td>
                    <td class="px-1 py-1.5 text-center">${team.SG}</td>
                    <td class="px-1 py-1.5 text-center font-bold">${team.Poin}</td>
                `;
                leagueTableBody.appendChild(row);
            });
        }

        function renderFixtures(league) {
            fixturesList.innerHTML = '';
            const matchesByWeek = (league.matches || []).reduce((acc, match) => {
                (acc[match.pekan] = acc[match.pekan] || []).push(match);
                return acc;
            }, {});

            Object.keys(matchesByWeek).sort((a,b) => a-b).forEach(pekan => {
                const weekContainer = document.createElement('div');
                weekContainer.className = 'bg-white p-4 rounded-lg shadow-md border border-gray-200/80';
                
                const table = document.createElement('table');
                table.className = 'w-full text-sm';
                table.innerHTML = `
                    <thead class="text-lg font-semibold text-purple-600">
                        <tr>
                            <th colspan="3" class="text-left pb-3">Pekan ${pekan}</th>
                        </tr>
                    </thead>
                `;

                const tbody = document.createElement('tbody');
                matchesByWeek[pekan].forEach((match, index) => {
                    if (match.homeTeam === 'Libur' || match.awayTeam === 'Libur') {
                        const byeTeam = match.homeTeam === 'Libur' ? match.awayTeam : match.homeTeam;
                        const rowColor = (index % 2 === 0) ? 'bg-gray-50' : 'bg-white';
                        tbody.innerHTML += `<tr class="${rowColor}"><td colspan="3" class="w-full text-center py-1 px-2 rounded-md truncate text-gray-500 italic">${byeTeam} (Libur)</td></tr>`;
                        return;
                    }
                    const isScheduled = match.status === 'Scheduled';
                    let scoreDisplay;
                    let homeColorClass = 'font-medium', awayColorClass = 'font-medium';
                    if (!isScheduled) {
                        if (match.homeScore > match.awayScore) {
                            homeColorClass = 'font-bold text-green-600'; awayColorClass = 'text-red-600';
                            scoreDisplay = `<span class="font-bold text-base text-green-600">${match.homeScore}</span><span class="text-gray-800">&nbsp;-&nbsp;</span><span class="font-bold text-base text-red-600">${match.awayScore}</span>`;
                        } else if (match.homeScore < match.awayScore) {
                            homeColorClass = 'text-red-600'; awayColorClass = 'font-bold text-green-600';
                            scoreDisplay = `<span class="font-bold text-base text-red-600">${match.homeScore}</span><span class="text-gray-800">&nbsp;-&nbsp;</span><span class="font-bold text-base text-green-600">${match.awayScore}</span>`;
                        } else {
                            homeColorClass = 'text-yellow-600'; awayColorClass = 'text-yellow-600';
                            scoreDisplay = `<span class="font-bold text-base text-yellow-600">${match.homeScore}&nbsp;-&nbsp;${match.awayScore}</span>`;
                        }
                    } else { scoreDisplay = `<span class="text-xs text-gray-500">VS</span>`; }
                    
                    const rowColor = (index % 2 === 0) ? 'bg-gray-50' : 'bg-white';
                    const matchRow = `<tr class="${rowColor}"><td class="w-2/5 text-right py-1 px-2 rounded-l-md truncate pr-3 ${homeColorClass}">${match.homeTeam}</td><td class="w-1/5 text-center py-1 px-2">${scoreDisplay}</td><td class="w-2/5 text-left py-1 px-2 rounded-r-md truncate pl-3 ${awayColorClass}">${match.awayTeam}</td></tr>`;
                    tbody.innerHTML += matchRow;
                    if (isAdmin && isScheduled) {
                        tbody.innerHTML += `<tr class="${rowColor}"><td colspan="3" class="pb-2 pt-1 px-2 text-center"><div class="flex items-center justify-center gap-2"><input type="number" min="0" id="homeScore-${match.matchId}" class="w-16 bg-gray-200 text-gray-800 text-center rounded border border-gray-300" placeholder="home"><span>-</span><input type="number" min="0" id="awayScore-${match.matchId}" class="w-16 bg-gray-200 text-gray-800 text-center rounded border border-gray-300" placeholder="away"><button onclick="updateScore(${match.matchId})" class="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-2 rounded-md font-semibold">Update</button></div></td></tr>`;
                    }
                });
                table.appendChild(tbody);
                weekContainer.appendChild(table);
                fixturesList.appendChild(weekContainer);
            });
        }
        
        function setAdminMode(enabled) {
            isAdmin = enabled;
            showLoginBtn.classList.toggle('hidden', enabled);
            exitAdminBtn.classList.toggle('hidden', !enabled);
            manageDataBtn.classList.toggle('hidden', !enabled);
            adminViewHeader.classList.toggle('hidden', !enabled);
            if (!enabled) managementModal.classList.add('hidden');
            renderAll();
        }

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (document.getElementById('password').value === 'adminganteng') {
                loginModal.classList.add('hidden'); loginForm.reset(); setAdminMode(true);
            } else { loginError.classList.remove('hidden'); }
        });
        
        exitAdminBtn.addEventListener('click', () => setAdminMode(false));
        showLoginBtn.addEventListener('click', () => loginModal.classList.remove('hidden'));
        closeLoginBtn.addEventListener('click', () => loginModal.classList.add('hidden'));
        leagueSelector.addEventListener('change', async (e) => {
            appData.activeLeagueId = e.target.value; await saveData(); renderAll();
        });

        function switchMainTab(targetTab) {
            allTabContents.forEach(c => c.classList.toggle('hidden', c.id !== `tab-content-${targetTab}`));
            allTabBtns.forEach(b => {
                const isActive = b.id === `tab-btn-${targetTab}`;
                b.classList.toggle('border-purple-500', isActive); b.classList.toggle('text-purple-600', isActive);
                b.classList.toggle('border-transparent', !isActive); b.classList.toggle('text-gray-500', !isActive);
            });
        }
        tabBtnKlasemen.addEventListener('click', () => switchMainTab('klasemen'));
        tabBtnJadwal.addEventListener('click', () => switchMainTab('jadwal'));

        const mgmtLeaguesList = document.getElementById('leagues-list'), mgmtTeamsList = document.getElementById('teams-list'), mgmtMatchesList = document.getElementById('matches-list');
        const leagueEditorModal = document.getElementById('league-editor-modal'), leagueEditorTitle = document.getElementById('league-editor-title'), leagueEditorName = document.getElementById('league-editor-name');
        const existingTeamsChecklist = document.getElementById('existing-teams-checklist'), newTeamsTextarea = document.getElementById('new-teams-textarea'), saveLeagueBtn = document.getElementById('save-league-btn'), cancelLeagueBtn = document.getElementById('cancel-league-btn');
        let editingLeagueId = null;

        manageDataBtn.addEventListener('click', () => { renderManagementModal(); managementModal.classList.remove('hidden'); });
        closeManagementBtn.addEventListener('click', () => managementModal.classList.add('hidden'));

        function renderManagementModal() {
            mgmtLeaguesList.innerHTML = '';
            appData.leagues.forEach(league => {
                const activeClass = league.id === appData.activeLeagueId ? 'bg-purple-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800';
                mgmtLeaguesList.innerHTML += `<div class="${activeClass} p-2 rounded-md flex justify-between items-center"><span class="font-semibold cursor-pointer" onclick="setActiveLeague('${league.id}')">${league.name}</span><div><button onclick="editLeague('${league.id}')" class="text-yellow-500 px-1">‚úèÔ∏è</button><button onclick="deleteLeague('${league.id}')" class="text-red-500 px-1">üóëÔ∏è</button></div></div>`;
            });
            const activeLeague = getActiveLeague();
            mgmtTeamsList.innerHTML = '';
            if(activeLeague && activeLeague.teams) {
                activeLeague.teams.forEach(team => { mgmtTeamsList.innerHTML += `<div class="bg-gray-200 p-2 rounded-md flex justify-between items-center"><span>${team}</span><div><button onclick="editTeam('${team}')" class="text-yellow-500 px-1">‚úèÔ∏è</button><button onclick="deleteTeam('${team}')" class="text-red-500 px-1">üóëÔ∏è</button></div></div>`; });
            }
            mgmtMatchesList.innerHTML = '';
            if(activeLeague && activeLeague.matches) {
                const matchesByWeek = activeLeague.matches.reduce((acc, m) => { (acc[m.pekan] = acc[m.pekan] || []).push(m); return acc; }, {});
                Object.keys(matchesByWeek).sort((a,b) => a-b).forEach(p => { mgmtMatchesList.innerHTML += `<h4 class="font-bold mt-2 text-gray-500">Pekan ${p}</h4>`; matchesByWeek[p].forEach(m => { mgmtMatchesList.innerHTML += `<div class="bg-gray-200 p-2 rounded-md flex justify-between items-center text-sm"><span>${m.homeTeam} vs ${m.awayTeam}</span><div><button onclick="editMatch(${m.matchId})" class="text-yellow-500 px-1">‚úèÔ∏è</button><button onclick="deleteMatch(${m.matchId})" class="text-red-500 px-1">üóëÔ∏è</button></div></div>`; }); });
            }
        }
        document.querySelectorAll('.tab-btn').forEach(b => { b.addEventListener('click', () => { document.querySelectorAll('.tab-btn').forEach(btn => { btn.classList.remove('border-purple-500', 'text-purple-600'); btn.classList.add('border-transparent', 'text-gray-500'); }); b.classList.add('border-purple-500', 'text-purple-600'); document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden')); document.getElementById(`${b.dataset.tab}-content`).classList.remove('hidden'); }); });
        
        window.setActiveLeague = async (id) => { appData.activeLeagueId = id; await saveData(); renderManagementModal(); };
        function openLeagueEditor(leagueId = null) {
            editingLeagueId = leagueId;
            leagueEditorName.value = ''; existingTeamsChecklist.innerHTML = ''; newTeamsTextarea.value = '';
            const allTeams = new Set();
            appData.leagues.forEach(l => l.teams.forEach(t => allTeams.add(t)));
            let leagueToEdit = null;
            if (leagueId) { leagueEditorTitle.textContent = 'Edit Liga'; leagueToEdit = appData.leagues.find(l => l.id === leagueId); leagueEditorName.value = leagueToEdit.name; } 
            else { leagueEditorTitle.textContent = 'Tambah Liga Baru'; }
            allTeams.forEach(teamName => { const isChecked = leagueToEdit && leagueToEdit.teams.includes(teamName) ? 'checked' : ''; existingTeamsChecklist.innerHTML += `<label class="flex items-center space-x-2 text-gray-700 hover:text-gray-900 cursor-pointer"><input type="checkbox" value="${teamName}" ${isChecked} class="form-checkbox bg-gray-200 border-gray-300 text-purple-600 focus:ring-purple-500"><span>${teamName}</span></label>`; });
            leagueEditorModal.classList.remove('hidden');
        }
        document.getElementById('add-league-btn').addEventListener('click', () => openLeagueEditor());
        cancelLeagueBtn.addEventListener('click', () => leagueEditorModal.classList.add('hidden'));
        saveLeagueBtn.addEventListener('click', async () => {
            const name = leagueEditorName.value.trim(); if (!name) { alert('Nama liga tidak boleh kosong.'); return; }
            const selectedTeams = Array.from(existingTeamsChecklist.querySelectorAll('input:checked')).map(i => i.value);
            const newTeams = newTeamsTextarea.value.split(',').map(t => t.trim()).filter(t => t.length > 0);
            const finalTeams = [...new Set([...selectedTeams, ...newTeams])];
            if (finalTeams.map(t => t.toLowerCase()).includes('libur')) { alert('Nama tim tidak boleh "Libur".'); return; }
            const generateMatches = document.getElementById('generate-matches-checkbox').checked;
            if (editingLeagueId) {
                const league = appData.leagues.find(l => l.id === editingLeagueId);
                league.name = name;
                const removedTeams = league.teams.filter(t => !finalTeams.includes(t));
                if (removedTeams.length > 0) league.matches = league.matches.filter(m => !removedTeams.includes(m.homeTeam) && !removedTeams.includes(m.awayTeam));
                league.teams = finalTeams;
                if (generateMatches && (!league.matches.length || confirm('Generate jadwal baru akan menghapus semua pertandingan yang ada. Lanjutkan?'))) league.matches = generateRoundRobinMatches(finalTeams);
            } else {
                const newLeague = { id: crypto.randomUUID(), name, teams: finalTeams, matches: [] };
                if (generateMatches) newLeague.matches = generateRoundRobinMatches(finalTeams);
                appData.leagues.push(newLeague); appData.activeLeagueId = newLeague.id;
            }
            await saveData(); renderAll(); leagueEditorModal.classList.add('hidden');
        });

        function generateRoundRobinMatches(teams) {
            const allMatches = []; if (teams.length < 2) return allMatches; let teamList = [...teams]; if (teamList.length % 2 !== 0) teamList.push("Libur");
            const numTeams = teamList.length, numRounds = numTeams - 1, halfSeasonMatches = [];
            for (let round = 0; round < numRounds; round++) { for (let i = 0; i < numTeams / 2; i++) halfSeasonMatches.push({ pekan: round + 1, homeTeam: teamList[i], awayTeam: teamList[numTeams - 1 - i] }); teamList.splice(1, 0, teamList.pop()); }
            halfSeasonMatches.forEach((m, i) => allMatches.push({ ...m, matchId: Date.now() + i, homeScore: null, awayScore: null, status: 'Scheduled' }));
            halfSeasonMatches.forEach((m, i) => allMatches.push({ pekan: m.pekan + numRounds, homeTeam: m.awayTeam, awayTeam: m.homeTeam, matchId: Date.now() + i + halfSeasonMatches.length, homeScore: null, awayScore: null, status: 'Scheduled' }));
            return allMatches;
        }

        window.editLeague = (id) => openLeagueEditor(id);
        window.deleteLeague = async (id) => { if(confirm('Yakin ingin menghapus liga ini?')) { appData.leagues = appData.leagues.filter(l => l.id !== id); if(appData.activeLeagueId === id) appData.activeLeagueId = appData.leagues.length ? appData.leagues[0].id : null; await saveData(); renderAll(); } };
        document.getElementById('add-team-btn').addEventListener('click', async () => { const n = prompt('Nama tim baru:'); if(n) { if(n.toLowerCase() === 'libur') { alert('Nama tim tidak boleh "Libur".'); return; } const l = getActiveLeague(); if (l && !l.teams.includes(n)) { l.teams.push(n); await saveData(); renderAll(); } else { alert('Tim sudah ada.'); } } });
        window.editTeam = async (o) => { const n = prompt('Nama tim baru:', o); if (n && n.toLowerCase() === 'libur') { alert('Nama tim tidak boleh "Libur".'); return; } const l = getActiveLeague(); if (n && n !== o && l) { l.teams = l.teams.map(t => t === o ? n : t); l.matches.forEach(m => { if (m.homeTeam === o) m.homeTeam = n; if (m.awayTeam === o) m.awayTeam = n; }); await saveData(); renderAll(); } };
        window.deleteTeam = async (n) => { if(confirm(`Hapus tim "${n}"?`)) { const l = getActiveLeague(); if(l){ l.teams = l.teams.filter(t => t !== n); l.matches = l.matches.filter(m => m.homeTeam !== n && m.awayTeam !== n); await saveData(); renderAll(); } } };
        document.getElementById('add-match-btn').addEventListener('click', async () => { const l = getActiveLeague(); if (!l || l.teams.length < 2) { alert('Tim tidak cukup.'); return; } const p = prompt('Pekan:'); const h = prompt(`Tim kandang:\n${l.teams.join(', ')}`); const a = prompt(`Tim tandang:\n${l.teams.join(', ')}`); if(p && h && a && l.teams.includes(h) && l.teams.includes(a) && h !== a) { l.matches.push({ pekan: parseInt(p), matchId: Date.now(), homeTeam: h, awayTeam: a, homeScore: null, awayScore: null, status: 'Scheduled' }); await saveData(); renderAll(); } else { alert('Input tidak valid.'); } });
        window.editMatch = (id) => { alert('Fungsi edit pertandingan belum diimplementasikan.'); };
        window.deleteMatch = async (id) => { if(confirm('Hapus pertandingan ini?')) { const l = getActiveLeague(); if(l){ l.matches = l.matches.filter(m => m.matchId !== id); await saveData(); renderAll(); } } };
        window.updateScore = async (matchId) => {
            const homeScore = parseInt(document.getElementById(`homeScore-${matchId}`).value, 10), awayScore = parseInt(document.getElementById(`awayScore-${matchId}`).value, 10);
            if (isNaN(homeScore) || isNaN(awayScore)) { alert('Skor harus angka.'); return; }
            const league = getActiveLeague(), match = league.matches.find(m => m.matchId === matchId);
            if (match) { match.homeScore = homeScore; match.awayScore = awayScore; match.status = 'Finished'; await saveData(); renderAll(); }
        };

        // --- INITIAL LOAD ---
        function initializeAppAndAuth() {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    await loadData();
                } else {
                    try {
                        const userCredential = await signInAnonymously(auth);
                        userId = userCredential.user.uid;
                        await loadData();
                    } catch (error) {
                        console.error("Anonymous sign-in failed", error);
                        loadingOverlay.innerHTML = '<p class="text-red-500">Gagal terhubung ke server. Coba refresh halaman.</p>';
                    }
                }
            });
        }
        
        initializeAppAndAuth();
    </script>
</body>
</html>

